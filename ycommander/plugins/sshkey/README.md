Commander Plugin for Rotating SSH keys
----

This plugin generates and rotates SSH keys then pushes the keys to one or more target systems.  The 'Login' field of the Keeper record defines the user account which is being rotated. The 'password' field will be automatically generated by Commander to be a strong passphrase that encrypts the private key.  The `cmdr:host` custom field defines the target host that will be updated with the public key. If multiple `cmdr:host` custom fields are provided, all target hosts will be updated. The resulting SSH private key and public key is stored in custom fields and sync'd to your Keeper vault.  Any Keeper user or Keeper Shared Folder associated with the record is updated instantly.

### Dependencies

1. This plugin requires **OpenSSL** and **OpenSSH** packages to be installed on the computer running Keeper Commander.

To verify this, open the Terminal application and make sure `'openssl'` and `'ssh'` commands are installed and accessible with the system **PATH** environment variable.

2. Specify the login name to the target system(s) in the **'Login'** field of the Keeper record

3. Commander will use **'Password'** field to store a strong passkey used to encrypt the private key.

4. Add the following 'Custom Fields' to the Keeper record

Name              | Value     | Comment
---------         | -------   | ------------
cmdr:plugin:xxx   | sshkey    | Required.  ```xxx``` is the "friendly" name which can be referenced in the command line interface instead of Record UID.
cmdr:host         |           | (Optional, Multiple) Host name or IP address of target server
cmdr:rules        |           | (Optional) [passphrase complexity rules](https://github.com/Keeper-Security/Commander/tree/master/keepercommander/plugins/password_rules.md)

NOTE: In order to automate the rotation of the public key on the target server, the public key must be manually updated `one time` in .ssh/authorized_keys on the target host(s).  After it has been set this first time, subsequent rotations will be automated and updated by Commander.

When setting up this plugin for the first time please use the following steps:
  
1. Populate the Title, Login, Custom Fields (cmdr:plugin:xxx, cmdr:host, cmdr:rules) of the Keeper record.
2. Execute the `rotate` command on the Keeper shell for this record. Commander will generate the public and private keys and store them in custom fields of the record. Copy or save the key in `cmdr:ssh_public_key` and save this public key to the file `.ssh/authorized_keys` in the target hosts - this step must be done manually the first time or you can use the `ssh-copy-id` unix command.  Make sure to set the permissions of the authorized_keys file on the target system. `chmod 700 ~/.ssh; chmod 600 ~/.ssh/authorized_keys`
3. Execute `rotate` command on Keeper shell to perform a full rotation.  If successful, the target hosts will be updated with the newly generated public key and the Keeper record will be updated with the private/public key pair.

<sub>**Note:** This plugin makes an assumption that the target system uses the default settings for SSH service, i.e. `authorized_keys` file is located in the `.ssh` directory of the user **HOME** directory.</sub>

### Output

When successful, this plugin adds/modifies the following record fields:

1. **'Password'** field contains the passkey used to encrypt the private key.  It is also rotated every time.

2. **'Custom Fields'**

Name                | Value   | Comment
-----------------   | ------- | --------
cmdr:ssh_public_key |         | Public key in SSH format. This key is uploaded to the target system.
cmdr:rsa_public_key |         | Public key in RSA format.
cmdr:private_key    |         | Private key encrypted with the passkey stored in the **'Password'** field

### Establishing a connection

Since the public key, private key and passphrase is regenerated every rotation, you need to pull down the latest private key file in order to connect to the destination server.  To verify this, copy-paste the `private_key` from the vault into your local filesystem and save it to a file such as `myprivatekey.pvk`.  On UNIX systems, make sure the permissions are set properly: `chmod 400 ~/myprivatekey.pvk`.  Now you can issue a connection using SSH:

`ssh -i ~/myprivatekey.pvk user@hostname`

Use the username and hostname field from your vault record.  You will be prompted for the passphrase.  Use the passphrase that is stored in Keeper's `password` field.
